<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Keuangan - Live Audit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- TEMA DEEP EMERALD --- */
        body { font-family: 'Inter', sans-serif; }
        
        #app { 
            min-height: 100vh;
            background-color: #000000;
            background-image: linear-gradient(135deg, #031e13 0%, #022c22 30%, #000000 60%, #60FF00 100%);
            background-attachment: fixed;
            color: #e2e8f0;
            padding-bottom: 120px; /* Ruang untuk tombol float */
        }

        /* Glass Card */
        .card {
            background: rgba(15, 15, 15, 0.75); 
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08); 
            position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .card:hover { border-color: rgba(255,255,255,0.2); }

        /* INPUT STYLES (Supaya terlihat seperti Teks Biasa tapi bisa diedit) */
        .live-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent; /* Garis bawah transparan */
            color: inherit;
            font-family: inherit;
            font-weight: inherit;
            font-size: inherit;
            width: 100%;
            text-align: inherit;
            transition: all 0.3s;
            padding: 0; margin: 0;
        }
        .live-input:hover {
            border-bottom: 1px solid rgba(255,255,255,0.3); /* Muncul garis saat hover */
            cursor: text;
        }
        .live-input:focus {
            outline: none;
            border-bottom: 1px solid #60FF00;
            background: rgba(255,255,255,0.05);
        }
        .live-input::placeholder { color: rgba(255,255,255,0.2); }

        /* Variasi Warna Card */
        .card-cyan { border-top: 4px solid #00FFFF; }
        .text-cyan-neon { color: #00FFFF; text-shadow: 0 0 15px rgba(0, 255, 255, 0.4); }

        .card-red { border-top: 4px solid #FF1053; }
        .text-red-neon { color: #FF1053; text-shadow: 0 0 15px rgba(255, 16, 83, 0.4); }

        .card-green { border-top: 4px solid #60FF00; }
        .text-green-neon { color: #60FF00; text-shadow: 0 0 15px rgba(96, 255, 0, 0.4); }

        .card-yellow { border-top: 4px solid #FFC700; }
        .text-yellow-neon { color: #FFC700; text-shadow: 0 0 15px rgba(255, 199, 0, 0.4); }

        .kpi-label { font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; opacity: 0.7; font-weight: 600; }
        .glow-blob { position: absolute; width: 80px; height: 80px; border-radius: 50%; filter: blur(50px); opacity: 0.2; z-index: 0; top: -20px; right: -20px; }
    </style>
</head>
<body>

<div id="app" class="flex flex-col items-center p-4 sm:p-8">
    
    <header class="w-full max-w-6xl mb-12 text-center z-10">
        <div class="inline-flex flex-col items-center justify-center bg-black/20 backdrop-blur-md border border-white/20 rounded-2xl p-4 md:px-10 shadow-inner group hover:border-green-500/50 transition">
            <h1 class="text-3xl md:text-5xl font-black mb-2 tracking-tight text-white drop-shadow-lg">TOKO ALBAROKAH JAHE</h1>
            
            <div class="flex items-center gap-2 justify-center mt-2">
                <input id="bulanNama" class="live-input text-xl font-bold text-green-400 w-32 text-center" value="Januari">
                <input id="tahunAngka" class="live-input text-xl font-bold text-green-400 w-20 text-center" value="2026">
            </div>
            <p class="text-xs text-gray-500 mt-2 opacity-0 group-hover:opacity-100 transition">Klik teks untuk mengedit</p>
        </div>
    </header>

    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 w-full max-w-6xl mb-12 z-10">
        
        <div class="card card-cyan p-6 group">
            <div class="glow-blob bg-cyan-500"></div>
            <div class="relative z-10">
                <div class="flex justify-between">
                    <p class="kpi-label text-cyan-200">1. TOTAL PEMASUKAN BERSIH</p>
                    <i class="fas fa-pen text-cyan-500/30 text-xs opacity-0 group-hover:opacity-100"></i>
                </div>
                
                <input type="text" id="omset" class="live-input text-4xl font-extrabold text-cyan-neon mt-2" onkeyup="formatMe(this); autoCalc()" placeholder="0">
                
                <div class="text-xs mt-4 text-gray-400 border-t border-cyan-500/20 pt-2 flex justify-between items-center">
                    <span>Retur (Pengurang):</span>
                    <input type="text" id="retur" class="live-input w-24 text-right text-red-400 font-bold" onkeyup="formatMe(this)" placeholder="0">
                </div>
            </div>
        </div>

        <div class="card card-red p-6 group">
            <div class="glow-blob bg-rose-500"></div>
            <div class="relative z-10">
                <div class="flex justify-between">
                    <p class="kpi-label text-rose-200">2. TOTAL PENGELUARAN (CASH)</p>
                </div>
                <p class="text-4xl font-extrabold text-red-neon mt-2" id="displayTotalKeluar">Rp 0</p>
                
                <div class="text-xs mt-4 text-gray-400 border-t border-rose-500/20 pt-2 space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-yellow-200 font-bold">Belanja Barang (Restok):</span>
                        <input type="text" id="belanja" class="live-input w-32 text-right text-yellow-300 font-bold bg-yellow-900/10 px-1 rounded" onkeyup="formatMe(this); autoCalc()" placeholder="0">
                    </div>
                    <div class="flex justify-between">
                        <span>Total Operasional:</span>
                        <span id="displayTotalOps" class="text-white">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card card-green p-6 group">
            <div class="glow-blob bg-emerald-500"></div>
            <div class="relative z-10">
                <div class="flex justify-between">
                    <p class="kpi-label text-emerald-200">3. LABA BERSIH USAHA</p>
                </div>
                
                <div class="flex justify-between items-end mt-2">
                     <p class="text-4xl font-extrabold text-green-neon" id="displayLabaBersih">Rp 0</p>
                     <span class="text-lg font-bold text-emerald-300 bg-emerald-900/40 px-3 py-1 rounded border border-emerald-500/30" id="displayMargin">0%</span>
                </div>
                
                <div class="text-xs mt-4 text-gray-400 border-t border-emerald-500/20 pt-2 space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-purple-300 font-bold">(-) HPP Total (Modal):</span>
                        <input type="text" id="hpp" class="live-input w-32 text-right text-purple-300 font-bold bg-purple-900/10 px-1 rounded" onkeyup="formatMe(this); autoCalc()" placeholder="0">
                    </div>
                    <div class="flex justify-between font-bold text-white">
                         <span>(=) Laba Kotor:</span>
                         <span id="displayLabaKotor" class="text-green-400">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card card-yellow p-6 group">
            <div class="glow-blob bg-amber-500"></div>
            <div class="relative z-10">
                <div class="flex justify-between">
                    <p class="kpi-label text-amber-200">4. NERACA</p>
                    <i class="fas fa-pen text-amber-500/30 text-xs opacity-0 group-hover:opacity-100"></i>
                </div>
                
                <div class="mt-4 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-400">Piutang:</span>
                        <input type="text" id="piutang" class="live-input w-1/2 text-right text-2xl font-bold text-white" onkeyup="formatMe(this)" placeholder="0">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-400">Hutang:</span>
                        <input type="text" id="hutang" class="live-input w-1/2 text-right text-2xl font-bold text-red-400" onkeyup="formatMe(this)" placeholder="0">
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <section class="w-full max-w-6xl z-10 mb-8 grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <div class="card p-6">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h3 class="font-bold text-red-500 text-xs uppercase">A. Ops Pokok</h3>
                <span id="displaySumPokok" class="text-xs font-mono text-gray-300">Rp 0</span>
            </div>
            <table class="w-full text-sm text-gray-400">
                <tbody id="bodyPokok"></tbody>
            </table>
            <button onclick="addRow('bodyPokok')" class="mt-4 w-full py-2 border border-dashed border-gray-600 text-gray-500 text-xs hover:text-white hover:border-white rounded transition">+ Tambah Baris</button>
        </div>

        <div class="card p-6">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h3 class="font-bold text-yellow-500 text-xs uppercase">B. Ops Lain-lain</h3>
                <span id="displaySumLain" class="text-xs font-mono text-gray-300">Rp 0</span>
            </div>
            <table class="w-full text-sm text-gray-400">
                <tbody id="bodyLain"></tbody>
            </table>
            <button onclick="addRow('bodyLain')" class="mt-4 w-full py-2 border border-dashed border-gray-600 text-gray-500 text-xs hover:text-white hover:border-white rounded transition">+ Tambah Baris</button>
        </div>

    </section>

    <div class="fixed bottom-8 right-8 z-50 flex flex-col items-end gap-2">
        <button onclick="generateUrl()" class="group flex items-center gap-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-3 px-6 rounded-full shadow-[0_0_20px_rgba(16,185,129,0.5)] transition-all hover:scale-105">
            <span>GENERATE NEW LINK</span>
            <i class="fas fa-link group-hover:rotate-45 transition"></i>
        </button>
    </div>

</div>

<div id="resultModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-[100] p-4">
    <div class="card w-full max-w-lg p-6 border-green-500/50">
        <h3 class="text-xl font-bold text-white mb-2">Link Baru Siap!</h3>
        <p class="text-gray-400 text-xs mb-4">Semua perubahan angka telah disimpan dalam link ini.</p>
        <textarea id="finalLink" class="w-full h-24 bg-black/50 border border-white/20 rounded p-3 text-[10px] font-mono text-green-400 mb-4 focus:outline-none" readonly></textarea>
        <div class="flex gap-3">
            <button onclick="document.getElementById('resultModal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">Tutup</button>
            <button onclick="copyLink()" class="flex-1 py-2 bg-green-600 text-white rounded hover:bg-green-500 font-bold text-sm">Salin Link</button>
        </div>
    </div>
</div>

<script>
    // --- 1. INISIALISASI SAAT LOAD ---
    window.onload = function() {
        const p = new URLSearchParams(window.location.search);
        // Cek parameter 'd' (Data Base64)
        const d = p.get('d');
        
        let DATA = {};
        
        if (d) {
            try {
                DATA = JSON.parse(atob(d));
            } catch(e) { console.error("Link rusak"); }
        } else {
            // Cek parameter AppSheet (Query Biasa)
            const getNum = (k) => Number(p.get(k)) || 0;
            const getStr = (k) => p.get(k) || "";
            
            // Logic AppSheet -> jika parameter 'total_pemasukan' ada, anggap dari AppSheet
            if(p.has('total_pemasukan')) {
                DATA.bln = getStr('bulan_nama');
                DATA.thn = getStr('tahun_angka');
                DATA.omset = getNum('total_pemasukan');
                DATA.retur = Math.abs(getNum('total_retur'));
                
                // Smart Split HPP vs Belanja
                const rawHpp = getNum('hpp_total') || getNum('total_belanja');
                const rawBelanja = getNum('total_belanja') || rawHpp;
                DATA.hpp = rawHpp;
                DATA.belanja = rawBelanja;
                
                DATA.hutang = getNum('total_hutang');
                DATA.piutang = getNum('total_piutang');
                
                try { DATA.pokok = JSON.parse(decodeURIComponent(getStr('beban_rincian') || "[]")); } catch(e){}
                try { DATA.lain = JSON.parse(decodeURIComponent(getStr('rincian_ops_lain_v') || "[]")); } catch(e){}
            }
        }

        // Isi ke Input Field
        setVal('bulanNama', DATA.bln || "Januari");
        setVal('tahunAngka', DATA.thn || "2026");
        setVal('omset', DATA.omset);
        setVal('retur', DATA.retur);
        setVal('hpp', DATA.hpp);
        setVal('belanja', DATA.belanja);
        setVal('hutang', DATA.hutang);
        setVal('piutang', DATA.piutang);

        // Isi Tabel
        const arrPokok = DATA.pokok || [];
        const arrLain = DATA.lain || [];
        
        if(arrPokok.length === 0) addRowData('bodyPokok', '', '');
        else arrPokok.forEach(x => addRowData('bodyPokok', x.uraian, x.jumlah));
        
        if(arrLain.length === 0) addRowData('bodyLain', '', '');
        else arrLain.forEach(x => addRowData('bodyLain', x.uraian, x.jumlah));

        // Hitung
        autoCalc();
    };

    // --- 2. LOGIKA INTERAKTIF ---
    function setVal(id, val) {
        const el = document.getElementById(id);
        if(el && val !== undefined) el.value = isNaN(val) ? val : Number(val).toLocaleString('id-ID');
    }

    function getVal(id) {
        const el = document.getElementById(id);
        return el ? (Number(el.value.replace(/[^0-9]/g, '')) || 0) : 0;
    }

    function formatMe(el) {
        let val = el.value.replace(/[^0-9]/g, '');
        if(!val) { el.value = ''; return; }
        el.value = Number(val).toLocaleString('id-ID');
    }

    // Fungsi Hitung Utama
    function autoCalc() {
        // Hitung Tabel
        let opsPokok = calcTableSum('bodyPokok');
        let opsLain = calcTableSum('bodyLain');
        let totalOps = opsPokok + opsLain;

        // Update UI Ops
        document.getElementById('displaySumPokok').innerText = "Rp " + opsPokok.toLocaleString('id-ID');
        document.getElementById('displaySumLain').innerText = "Rp " + opsLain.toLocaleString('id-ID');
        document.getElementById('displayTotalOps').innerText = "Rp " + totalOps.toLocaleString('id-ID');

        // Ambil Data Utama
        const omset = getVal('omset');
        const hpp = getVal('hpp');        // Dipakai untuk Laba
        const belanja = getVal('belanja'); // Dipakai untuk Cashflow

        // 1. CASHFLOW
        const totalKeluar = belanja + totalOps;
        document.getElementById('displayTotalKeluar').innerText = "Rp " + totalKeluar.toLocaleString('id-ID');

        // 2. LABA RUGI
        const labaKotor = omset - hpp;
        const labaBersih = labaKotor - totalOps;
        const margin = omset ? (labaBersih/omset*100) : 0;

        document.getElementById('displayLabaKotor').innerText = "Rp " + labaKotor.toLocaleString('id-ID');
        
        // Style Laba Bersih (Merah/Hijau)
        const elLaba = document.getElementById('displayLabaBersih');
        elLaba.innerText = "Rp " + labaBersih.toLocaleString('id-ID');
        if(labaBersih < 0) {
            elLaba.classList.remove('text-green-neon'); elLaba.classList.add('text-red-neon');
        } else {
            elLaba.classList.add('text-green-neon'); elLaba.classList.remove('text-red-neon');
        }

        document.getElementById('displayMargin').innerText = margin.toFixed(1) + "%";
    }

    function calcTableSum(tbodyId) {
        let sum = 0;
        document.querySelectorAll(`#${tbodyId} .row-jumlah`).forEach(el => {
            sum += Number(el.value.replace(/[^0-9]/g, '')) || 0;
        });
        return sum;
    }

    // --- 3. MANAJEMEN TABEL ---
    function addRow(tbodyId) {
        addRowData(tbodyId, '', '');
    }

    function addRowData(tbodyId, uraian, jumlah) {
        const tbody = document.getElementById(tbodyId);
        const tr = document.createElement('tr');
        const valJumlah = jumlah ? Number(jumlah).toLocaleString('id-ID') : '';
        
        tr.className = "group hover:bg-white/5 border-b border-white/5";
        tr.innerHTML = `
            <td class="p-1">
                <input type="text" class="live-input text-sm row-uraian" value="${uraian}" placeholder="Ketuk utk edit...">
            </td>
            <td class="p-1 w-28">
                <input type="text" class="live-input text-sm text-right row-jumlah" value="${valJumlah}" onkeyup="formatMe(this); autoCalc()" placeholder="0">
            </td>
            <td class="p-1 w-6 text-center opacity-0 group-hover:opacity-100 transition">
                <button onclick="this.closest('tr').remove(); autoCalc()" class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    }

    // --- 4. GENERATE URL ---
    function generateUrl() {
        // Ambil Data Rincian
        const getRowData = (tbodyId) => {
            let res = [];
            document.querySelectorAll(`#${tbodyId} tr`).forEach(tr => {
                let u = tr.querySelector('.row-uraian').value;
                let j = Number(tr.querySelector('.row-jumlah').value.replace(/[^0-9]/g, ''));
                if(u && j) res.push({uraian: u, jumlah: j});
            });
            return res;
        };

        const payload = {
            bln: document.getElementById('bulanNama').value,
            thn: document.getElementById('tahunAngka').value,
            omset: getVal('omset'),
            retur: getVal('retur'),
            hpp: getVal('hpp'),
            belanja: getVal('belanja'),
            hutang: getVal('hutang'),
            piutang: getVal('piutang'),
            pokok: getRowData('bodyPokok'),
            lain: getRowData('bodyLain')
        };

        const jsonStr = JSON.stringify(payload);
        const encoded = btoa(jsonStr);
        
        // Buat Link Bersih
        const baseUrl = window.location.href.split('?')[0];
        const finalUrl = `${baseUrl}?d=${encoded}`;

        document.getElementById('finalLink').value = finalUrl;
        document.getElementById('resultModal').classList.remove('hidden');
    }

    function copyLink() {
        const el = document.getElementById('finalLink');
        el.select();
        document.execCommand('copy');
        alert("Link tersalin!");
    }
</script>

</body>
</html>
