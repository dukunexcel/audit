<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Keuangan - Albarokah Jahe</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        #app { 
            min-height: 100vh;
            background-color: #000000;
            background-image: linear-gradient(135deg, #031e13 0%, #022c22 30%, #000000 60%, #0f3900 100%);
            background-attachment: fixed;
            color: #e2e8f0;
            padding-bottom: 50px;
        }

        /* Glassmorphism Card */
        .glass-card {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-5px); border-color: rgba(96, 255, 0, 0.3); }

        /* Neon Text Utilities */
        .text-neon-green { color: #60FF00; text-shadow: 0 0 10px rgba(96, 255, 0, 0.3); }
        .text-neon-red { color: #ff4d4d; text-shadow: 0 0 10px rgba(255, 77, 77, 0.3); }
        .text-neon-cyan { color: #22d3ee; text-shadow: 0 0 10px rgba(34, 211, 238, 0.3); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    </style>
</head>
<body>

<div id="app" class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-8">
        
        <div class="flex flex-col md:flex-row justify-between items-end border-b border-white/10 pb-6">
            <div>
                <h1 class="text-4xl font-black tracking-tighter text-white mb-2">
                    DASHBOARD <span class="text-neon-green">KEUANGAN</span>
                </h1>
                <p class="text-gray-400 text-sm flex items-center gap-2">
                    <i class="fas fa-calendar-alt text-neon-green"></i> 
                    Periode: <span id="displayPeriode" class="font-bold text-white">Menunggu Data...</span>
                </p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <div class="text-xs text-gray-500 uppercase tracking-widest mb-1">Status Data</div>
                <div id="dataStatus" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-800 text-xs font-bold text-gray-400 border border-gray-700">
                    <div class="w-2 h-2 rounded-full bg-gray-500"></div> Default Mode
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            
            <div class="glass-card p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-coins text-6xl text-cyan-400"></i></div>
                <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Total Penjualan Kotor</p>
                <h3 id="dispOmset" class="text-2xl md:text-3xl font-black text-white">Rp 0</h3>
                <div class="mt-4 text-xs text-cyan-400 border-t border-white/10 pt-2 flex justify-between">
                    <span>Retur:</span>
                    <span id="dispRetur" class="font-mono text-red-400">-Rp 0</span>
                </div>
            </div>

            <div class="glass-card p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-money-bill-wave text-6xl text-blue-400"></i></div>
                <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Pemasukan Bersih</p>
                <h3 id="dispPemasukan" class="text-2xl md:text-3xl font-black text-blue-100">Rp 0</h3>
                <div class="mt-4 text-xs text-gray-400 border-t border-white/10 pt-2">
                    Net Revenue (Setelah Retur)
                </div>
            </div>

            <div class="glass-card p-6 relative overflow-hidden group border-b-4 border-green-500">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-chart-line text-6xl text-neon-green"></i></div>
                <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Laba Bersih (Net Profit)</p>
                <h3 id="dispLabaBersih" class="text-2xl md:text-3xl font-black text-neon-green">Rp 0</h3>
                <div class="mt-4 text-xs text-gray-400 border-t border-white/10 pt-2 flex justify-between">
                    <span>Margin:</span>
                    <span id="dispMarginPersen" class="font-bold text-white">0%</span>
                </div>
            </div>

            <div class="glass-card p-6 relative overflow-hidden group border-b-4 border-purple-500">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-wallet text-6xl text-purple-400"></i></div>
                <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Arus Kas (Cashflow)</p>
                <h3 id="dispArusKas" class="text-2xl md:text-3xl font-black text-purple-300">Rp 0</h3>
                <div class="mt-4 text-xs text-gray-400 border-t border-white/10 pt-2">
                    Real Cash (In - Out)
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="glass-card p-6 lg:col-span-1">
                <h4 class="text-sm font-bold text-white mb-4 border-b border-white/10 pb-2">STRUKTUR PENGELUARAN</h4>
                <div class="relative h-64">
                    <canvas id="chartPengeluaran"></canvas>
                </div>
            </div>

            <div class="glass-card p-6 lg:col-span-2">
                <h4 class="text-sm font-bold text-white mb-4 border-b border-white/10 pb-2">ANALISA MARGIN (PRODUK & KANAL)</h4>
                <div class="relative h-64">
                    <canvas id="chartMargin"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="glass-card p-0 overflow-hidden">
                <div class="bg-red-900/20 p-4 border-b border-white/10 flex justify-between">
                    <h4 class="font-bold text-red-400 text-sm">OPS. POKOK</h4>
                    <span id="sumPokok" class="font-mono text-xs font-bold text-white bg-red-600/50 px-2 rounded">Rp 0</span>
                </div>
                <div class="p-4 h-64 overflow-y-auto custom-scroll">
                    <table class="w-full text-xs text-left">
                        <tbody id="tablePokok" class="divide-y divide-white/5 text-gray-300"></tbody>
                    </table>
                </div>
            </div>

            <div class="glass-card p-0 overflow-hidden">
                <div class="bg-yellow-900/20 p-4 border-b border-white/10 flex justify-between">
                    <h4 class="font-bold text-yellow-400 text-sm">OPS. LAIN-LAIN</h4>
                    <span id="sumLain" class="font-mono text-xs font-bold text-white bg-yellow-600/50 px-2 rounded">Rp 0</span>
                </div>
                <div class="p-4 h-64 overflow-y-auto custom-scroll">
                    <table class="w-full text-xs text-left">
                        <tbody id="tableLain" class="divide-y divide-white/5 text-gray-300"></tbody>
                    </table>
                </div>
            </div>

            <div class="glass-card p-6 flex flex-col justify-between">
                <div>
                    <h4 class="text-sm font-bold text-white mb-4 border-b border-white/10 pb-2">POSISI KEUANGAN</h4>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5">
                            <span class="text-xs text-yellow-500 uppercase font-bold">Total Hutang</span>
                            <span id="dispHutang" class="font-mono font-bold text-yellow-400">Rp 0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5">
                            <span class="text-xs text-purple-400 uppercase font-bold">Total Piutang</span>
                            <span id="dispPiutang" class="font-mono font-bold text-purple-300">Rp 0</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-white/10">
                    <h4 class="text-sm font-bold text-white mb-2">HPP vs BELANJA</h4>
                    <div class="text-xs space-y-2">
                        <div class="flex justify-between text-gray-400">
                            <span>HPP (Cost of Goods):</span>
                            <span id="dispHPP" class="text-white">Rp 0</span>
                        </div>
                        <div class="flex justify-between text-gray-400">
                            <span>Total Belanja (Cash Out):</span>
                            <span id="dispBelanja" class="text-white">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="glass-card p-0 overflow-hidden">
             <div class="bg-gray-800/50 p-4 border-b border-white/10">
                <h4 class="font-bold text-white text-sm">DETAIL MARGIN PER KATEGORI</h4>
            </div>
            <div class="p-0 overflow-x-auto">
                <table class="w-full text-xs text-left text-gray-300">
                    <thead class="bg-white/5 text-gray-100 uppercase font-bold">
                        <tr>
                            <th class="px-6 py-3">Kategori</th>
                            <th class="px-6 py-3 text-right">Omset</th>
                            <th class="px-6 py-3 text-right">HPP</th>
                            <th class="px-6 py-3 text-right">Laba</th>
                            <th class="px-6 py-3 text-right">Margin %</th>
                        </tr>
                    </thead>
                    <tbody id="tableMarginBody" class="divide-y divide-white/5">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="text-center text-xs text-gray-600 pb-8">
            &copy; 2026 Albarokah Jahe Financial System. Generated via AppSheet.
        </div>

    </div>
</div>

<script>
    // --- 1. STATE MANAGEMENT ---
    const DATA = {
        // Defaults (Kosong)
        bulan: '-', tahun: '-',
        penjualanKotor: 0, totalRetur: 0, totalPemasukan: 0,
        hppTotal: 0, totalBelanja: 0,
        labaKotor: 0, labaBersih: 0, arusKasBersih: 0,
        opsLain: 0, opsNonPrive: 0, // opsNonPrive = Total Ops
        totalHutang: 0, totalPiutang: 0,
        
        // Margin
        hppBpom: 0, labaBpom: 0, omsetBpom: 0,
        hppNonBpom: 0, labaNonBpom: 0, omsetNonBpom: 0,
        hppOnline: 0, labaOnline: 0, omsetOnline: 0,
        hppOffline: 0, labaOffline: 0, omsetOffline: 0,

        // Arrays
        rincianPokok: [],
        rincianLain: []
    };

    // --- 2. URL PARAMETER PARSER (THE ENGINE) ---
    function loadData() {
        const p = new URLSearchParams(window.location.search);
        
        // Cek Trigger
        if (!p.has('penjualan_kotor')) {
            console.log("No Data Params. Showing defaults.");
            return;
        }

        // Update Status UI
        const statusEl = document.getElementById('dataStatus');
        statusEl.innerHTML = `<div class="w-2 h-2 rounded-full bg-neon-green shadow-[0_0_10px_#60FF00]"></div> Live Data`;
        statusEl.classList.replace('border-gray-700', 'border-green-500/50');
        statusEl.classList.replace('text-gray-400', 'text-green-400');

        // Helper Get Number
        const n = (k) => Number(p.get(k)) || 0;

        // Basic Info
        DATA.bulan = p.get('bulan_nama') || '-';
        DATA.tahun = p.get('tahun_angka') || '-';

        // KPI
        DATA.penjualanKotor = n('penjualan_kotor');
        DATA.totalRetur = n('total_retur');
        DATA.totalPemasukan = n('total_pemasukan');
        
        DATA.hppTotal = n('hpp_total');      // Untuk Laba
        DATA.totalBelanja = n('total_belanja'); // Untuk Cashflow
        
        DATA.labaKotor = n('laba_kotor');
        DATA.labaBersih = n('laba_bersih');
        DATA.arusKasBersih = n('arus_kas_bersih');
        
        DATA.opsLain = n('ops_lain_lain');
        DATA.opsNonPrive = n('ops_non_prive'); // Ini Total Ops di rumus Admin

        DATA.totalHutang = n('total_hutang');
        DATA.totalPiutang = n('total_piutang');

        // Margin
        DATA.hppBpom = n('hpp_bpom'); DATA.labaBpom = n('laba_bpom'); DATA.omsetBpom = n('omset_bpom');
        DATA.hppNonBpom = n('hpp_non_bpom'); DATA.labaNonBpom = n('laba_non_bpom'); DATA.omsetNonBpom = n('omset_non_bpom');
        DATA.hppOnline = n('hpp_online'); DATA.labaOnline = n('laba_online'); DATA.omsetOnline = n('omset_online');
        DATA.hppOffline = n('hpp_offline'); DATA.labaOffline = n('laba_offline'); DATA.omsetOffline = n('omset_offline');

        // JSON Arrays (Fix Trailing Comma)
        const parseArr = (k) => {
            if(!p.has(k)) return [];
            try {
                let raw = p.get(k).replace(/,\s*\]$/, ']'); // Remove trailing comma
                return JSON.parse(raw);
            } catch(e) { console.error('JSON Error', e); return []; }
        };

        DATA.rincianPokok = parseArr('beban_rincian');
        DATA.rincianLain = parseArr('rincian_ops_lain_v');
    }

    // --- 3. RENDER UI ---
    function renderUI() {
        // Text Updates
        document.getElementById('displayPeriode').innerText = `${DATA.bulan} ${DATA.tahun}`;
        
        const fmt = (v) => "Rp " + Number(v).toLocaleString('id-ID');
        
        document.getElementById('dispOmset').innerText = fmt(DATA.penjualanKotor);
        document.getElementById('dispRetur').innerText = "- " + fmt(DATA.totalRetur);
        document.getElementById('dispPemasukan').innerText = fmt(DATA.totalPemasukan);
        
        const elLaba = document.getElementById('dispLabaBersih');
        elLaba.innerText = fmt(DATA.labaBersih);
        elLaba.className = DATA.labaBersih < 0 ? "text-2xl md:text-3xl font-black text-red-500" : "text-2xl md:text-3xl font-black text-neon-green";

        const elKas = document.getElementById('dispArusKas');
        elKas.innerText = fmt(DATA.arusKasBersih);
        elKas.className = DATA.arusKasBersih < 0 ? "text-2xl md:text-3xl font-black text-red-400" : "text-2xl md:text-3xl font-black text-purple-300";

        // Margin Percentage
        const marginP = DATA.totalPemasukan > 0 ? ((DATA.labaBersih / DATA.totalPemasukan) * 100).toFixed(1) : 0;
        document.getElementById('dispMarginPersen').innerText = marginP + "%";

        // Neraca & HPP
        document.getElementById('dispHutang').innerText = fmt(DATA.totalHutang);
        document.getElementById('dispPiutang').innerText = fmt(DATA.totalPiutang);
        document.getElementById('dispHPP').innerText = fmt(DATA.hppTotal);
        document.getElementById('dispBelanja').innerText = fmt(DATA.totalBelanja);

        // Sum Ops
        document.getElementById('sumPokok').innerText = fmt(DATA.rincianPokok.reduce((a,b)=>a+b.jumlah,0));
        document.getElementById('sumLain').innerText = fmt(DATA.rincianLain.reduce((a,b)=>a+b.jumlah,0));

        // Render Tables
        fillTable('tablePokok', DATA.rincianPokok);
        fillTable('tableLain', DATA.rincianLain);
        renderMarginTable();

        // Render Charts
        renderCharts();
    }

    function fillTable(id, arr) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        arr.forEach(x => {
            el.innerHTML += `
                <tr class="hover:bg-white/5">
                    <td class="py-2 pr-2">${x.uraian}</td>
                    <td class="py-2 text-right font-mono text-white">Rp ${Number(x.jumlah).toLocaleString('id-ID')}</td>
                </tr>`;
        });
    }

    function renderMarginTable() {
        const body = document.getElementById('tableMarginBody');
        const row = (label, omset, hpp, laba, colorClass) => {
            const pct = omset > 0 ? ((laba/omset)*100).toFixed(1) : 0;
            return `
                <tr class="hover:bg-white/5 transition">
                    <td class="px-6 py-3 font-bold ${colorClass}">${label}</td>
                    <td class="px-6 py-3 text-right font-mono text-gray-300">Rp ${Number(omset).toLocaleString('id-ID')}</td>
                    <td class="px-6 py-3 text-right font-mono text-gray-400">Rp ${Number(hpp).toLocaleString('id-ID')}</td>
                    <td class="px-6 py-3 text-right font-mono font-bold ${laba<0?'text-red-400':'text-white'}">Rp ${Number(laba).toLocaleString('id-ID')}</td>
                    <td class="px-6 py-3 text-right font-mono font-bold ${colorClass}">${pct}%</td>
                </tr>
            `;
        };

        let html = '';
        html += row('BPOM', DATA.omsetBpom, DATA.hppBpom, DATA.labaBpom, 'text-cyan-400');
        html += row('Non-BPOM', DATA.omsetNonBpom, DATA.hppNonBpom, DATA.labaNonBpom, 'text-cyan-400');
        html += `<tr class="border-t border-white/5"><td colspan="5"></td></tr>`;
        html += row('Online', DATA.omsetOnline, DATA.hppOnline, DATA.labaOnline, 'text-purple-400');
        html += row('Offline', DATA.omsetOffline, DATA.hppOffline, DATA.labaOffline, 'text-purple-400');
        body.innerHTML = html;
    }

    // --- 4. CHARTS CONFIGURATION ---
    function renderCharts() {
        // Chart 1: Struktur Pengeluaran
        const ctxPie = document.getElementById('chartPengeluaran').getContext('2d');
        
        // Hitung total ops untuk pie chart
        const totalOps = DATA.rincianPokok.reduce((a,b)=>a+b.jumlah,0) + DATA.rincianLain.reduce((a,b)=>a+b.jumlah,0);
        
        new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: ['HPP/Barang', 'Ops Pokok', 'Ops Lain', 'Laba Bersih'],
                datasets: [{
                    data: [DATA.hppTotal, DATA.rincianPokok.reduce((a,b)=>a+b.jumlah,0), DATA.rincianLain.reduce((a,b)=>a+b.jumlah,0), DATA.labaBersih],
                    backgroundColor: ['#f43f5e', '#fbbf24', '#a8a29e', '#60FF00'],
                    borderColor: '#000',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#fff', font: {size: 10} } }
                }
            }
        });

        // Chart 2: Margin Comparison (Bar)
        const ctxBar = document.getElementById('chartMargin').getContext('2d');
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['BPOM', 'Non-BPOM', 'Online', 'Offline'],
                datasets: [
                    {
                        label: 'Omset',
                        data: [DATA.omsetBpom, DATA.omsetNonBpom, DATA.omsetOnline, DATA.omsetOffline],
                        backgroundColor: 'rgba(34, 211, 238, 0.5)',
                        borderColor: '#22d3ee',
                        borderWidth: 1
                    },
                    {
                        label: 'Laba',
                        data: [DATA.labaBpom, DATA.labaNonBpom, DATA.labaOnline, DATA.labaOffline],
                        backgroundColor: 'rgba(96, 255, 0, 0.7)',
                        borderColor: '#60FF00',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { color: '#94a3b8', font: {size: 10} }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#fff', font: {size: 11, weight:'bold'} }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#fff' } }
                }
            }
        });
    }

    // --- MAIN INIT ---
    window.onload = function() {
        loadData();
        renderUI();
    };
</script>

</body>
</html>
